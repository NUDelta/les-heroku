#! /app/.heroku/node/bin/node
const Parse = require('parse/node');
const push = require('../cloud/push.js');
const _ = require('lodash');
const moment = require('moment');

Parse.initialize('PkngqKtJygU9WiQ1GXM9eC0a17tKmioKKmpWftYr');
Parse.serverURL = process.env.SERVER_URL || 'http://localhost:5000/parse';

const notifyDeadApps = function notifyDeadApps() {
  // setup time threshold
  const timeExpiryThreshold = moment().subtract(8, 'hours').toDate();

  // find all users who have had a heartbeat in the last 8 hours
  const heartbeatQuery = new Parse.Query('ApplicationHeartbeat');
  heartbeatQuery.equalTo('logString', 'Application heartbeat');
  heartbeatQuery.greaterThanOrEqualTo('createdAt', timeExpiryThreshold);
  heartbeatQuery.descending('createdAt');
  heartbeatQuery.limit(10000);
  heartbeatQuery.find().then(heartbeats => {
    // get all users with valid heartbeats
    const vendorIdSet = new Set();
    _.forEach(heartbeats, (currentHeartbeat) => {
      vendorIdSet.add(currentHeartbeat.get('vendorId'));
    });

    // query for all users who do not have valid heartbeats
    const userQuery = new Parse.Query(Parse.User);
    userQuery.notContainedIn('vendorId', Array.from(vendorIdSet));
    userQuery.descending('createdAt');
    return userQuery.find();
  }).then(users => {
    const pushTokens = [];
    const vendorIds = [];

    _.forEach(users, (currentUser) => {
      if (currentUser.get('pushToken') !== '') {
        pushTokens.push(currentUser.get('pushToken'));
        vendorIds.push(currentUser.get('vendorId'));
      }
    });

    const message = 'Hi! Looks like LES closed on your phone. ' +
      'Remember! don\'t swipe up to terminate LES, and please limit low-battery mode usage. ' +
      'Tap/swipe on me start it up again!';
    push.sendPushWithMessage(pushTokens, message, undefined);

    // successfully notified dead apps
    let ServerLog = Parse.Object.extend('ServerLog');
    let newServerLog = new ServerLog();
    newServerLog.set('caller', 'notifyDeadApps');
    newServerLog.set('success', true);
    newServerLog.set('logString',
      'Notified dead applications for IDs: [' + vendorIds.join(', ') + ']');
    return newServerLog.save();
  }).catch(error => {
    console.error(error);

    // unsuccessfully notified dead apps
    let ServerLog = Parse.Object.extend('ServerLog');
    let newServerLog = new ServerLog();
    newServerLog.set('caller', 'notifyDeadApps');
    newServerLog.set('success', false);
    newServerLog.set('logString', 'Error in notifying dead applications: ' + error);
    return newServerLog.save();
  });
};

notifyDeadApps();
