#! /app/.heroku/node/bin/node
var Parse = require('parse/node');
var push = require('../cloud/push.js');

Parse.initialize('PkngqKtJygU9WiQ1GXM9eC0a17tKmioKKmpWftYr');
Parse.serverURL = 'https://les-expand.herokuapp.com/parse/';
// Parse.Cloud.useMasterKey();

function rotateConditions() {
  var studyConditionQuery = new Parse.Query('studyConditions');
  studyConditionQuery.each(function(user) {
    // get current condition
    var conditionArray = user.get('conditionOrdering');
    var currentCondition = user.get('currentCondition');

    // find condition index and increment by 1
    var newConditionIndex = (conditionArray.indexOf(currentCondition) + 1) % conditionArray.length;
    var nextCondition = conditionArray[newConditionIndex];

    // save new condition
    user.set('currentCondition', nextCondition);
    user.save();
  }).then(function() {
    response.success();
  }, function(error) {
    response.error(error);
  });
};

rotateConditions();
