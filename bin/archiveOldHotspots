#! /app/.heroku/node/bin/node
const Parse = require('parse/node');
const moment = require('moment');

Parse.initialize('PkngqKtJygU9WiQ1GXM9eC0a17tKmioKKmpWftYr');
Parse.serverURL = 'https://les-expand.herokuapp.com/parse/';

const archiveOldHotspots = function () {
  // setup time thresholding
  const timeExpiryThreshold = moment().subtract(4, 'hours').toDate();

  // fetch objects that are ready to be archived
  const taskLocationQuery = new Parse.Query('TaskLocations');
  taskLocationQuery.notEqualTo('archived', true);
  taskLocationQuery.lessThan('createdAt', timeExpiryThreshold);
  taskLocationQuery.each(function (hotspot) {
    hotspot.set('archiver', 'system');
    hotspot.save();
  }).then(function () {
    status.success('Routine archiving completed successfully.');
  }, function (error) {
    status.error('Routine archiving failed with error ' + error);
  });
};

archiveOldHotspots();
